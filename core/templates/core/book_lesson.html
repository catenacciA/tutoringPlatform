{% extends "base.html" %}
{% load static crispy_forms_tags %}

{% block title %}Book Lesson with {{ tutor.user.get_full_name }}{% endblock %}

{% block header_content %}
<h1 class="text-center my-4">Book Lesson with {{ tutor.user.get_full_name }}</h1>
{% endblock %}

{% block content %}
<div class="container mt-5">
    <form id="bookLessonForm" method="post" action="{% url 'core:book_lesson' tutor.id %}">
        {% csrf_token %}
        <div class="form-group">
            <label for="subject"><i class="fas fa-book"></i> Subject:</label>
            <select id="subject" name="subject" class="form-control" required>
                <option value="">Select a subject</option>
                {% for subject in subjects %}
                    <option value="{{ subject.id }}">{{ subject.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="booking_date"><i class="fas fa-calendar-alt"></i> Booking Date:</label>
            <input type="date" id="booking_date" name="booking_date" class="form-control" min="{{ today }}" required>
        </div>
        <div class="form-group">
            <label for="available_slots"><i class="fas fa-clock"></i> Available Time Slots:</label>
            <table class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <th>Day of Week</th>
                        <th>Start Time</th>
                        <th>End Time</th>
                    </tr>
                </thead>
                <tbody id="available_slots_body">
                    <!-- JavaScript will populate this -->
                </tbody>
            </table>
        </div>
        <div class="form-group">
            <label for="custom_start_time"><i class="fas fa-clock"></i> Custom Start Time:</label>
            <input type="time" id="custom_start_time" name="custom_start_time" class="form-control" required>
        </div>
        <div class="form-group">
            <label for="custom_end_time"><i class="fas fa-clock"></i> Custom End Time:</label>
            <input type="time" id="custom_end_time" name="custom_end_time" class="form-control" required>
        </div>
        <button type="submit" class="btn btn-primary btn-block mt-3"><i class="fas fa-check"></i> Book Lesson</button>
    </form>
    <div id="form-messages" class="mt-3"></div>
</div>

<!-- Adding FontAwesome for icons and some custom styling -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<style>
    .container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    .form-group label {
        font-weight: bold;
        margin-top: 10px;
    }
    .table thead th {
        background-color: #f8f9fa;
    }
    .text-success, .text-danger {
        margin-top: 10px;
    }
    .btn-primary {
        background-color: #007bff;
        border-color: #007bff;
    }
</style>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
$(document).ready(function(){
    const availabilities = {{ availabilities|safe }};

    function populateAvailabilities() {
        const $tbody = $('#available_slots_body');
        $tbody.empty();
        availabilities.forEach(slot => {
            const startTime = slot.start_time.substring(0, 5);
            const endTime = slot.end_time.substring(0, 5);
            $tbody.append(`
                <tr>
                    <td>${slot.day_of_week}</td>
                    <td>${startTime}</td>
                    <td>${endTime}</td>
                </tr>
            `);
        });
    }

    function validateTime(startTime, endTime) {
        const start = new Date(`1970-01-01T${startTime}:00Z`);
        const end = new Date(`1970-01-01T${endTime}:00Z`);
        return start < end;
    }

    populateAvailabilities();

    $('#bookLessonForm').on('submit', function(event){
        event.preventDefault();
        const $form = $(this);
        const formData = $form.serializeArray();
        const startTime = $('#custom_start_time').val();
        const endTime = $('#custom_end_time').val();
        const bookingDate = $('#booking_date').val();

        // Client-side validation
        if (!validateTime(startTime, endTime)) {
            $('#form-messages').html('<p class="text-danger"><i class="fas fa-exclamation-circle"></i> End time must be after start time.</p>');
            return;
        }

        if (!bookingDate) {
            $('#form-messages').html('<p class="text-danger"><i class="fas fa-exclamation-circle"></i> Please select a booking date.</p>');
            return;
        }

        formData.push({name: 'start_time', value: startTime});
        formData.push({name: 'end_time', value: endTime});

        $.ajax({
            type: 'POST',
            url: $form.attr('action'),
            data: $.param(formData),
            success: function(response){
                if (response.queued) {
                    $('#form-messages').html(`<p class="text-info"><i class="fas fa-info-circle"></i> The selected slot is already booked. You have been added to the queue. Your position in the queue is ${response.position}.</p>`);
                } else {
                    $('#form-messages').html('<p class="text-success"><i class="fas fa-check-circle"></i> Your lesson has been booked successfully.</p>');
                    $form[0].reset();
                    populateAvailabilities(); // Refresh available slots
                }
            },
            error: function(response){
                console.error(response);
                const errors = response.responseJSON.errors;
                let errorMessages = '<p class="text-danger"><i class="fas fa-exclamation-circle"></i> There was an error booking your lesson:</p>';
                for (const error in errors) {
                    if (Array.isArray(errors[error])) {
                        errors[error].forEach(err => {
                            errorMessages += `<p class="text-danger"><i class="fas fa-exclamation-circle"></i> ${err}</p>`;
                        });
                    } else {
                        errorMessages += `<p class="text-danger"><i class="fas fa-exclamation-circle"></i> ${errors[error]}</p>`;
                    }
                }
                $('#form-messages').html(errorMessages);
            }
        });
    });
});
</script>
{% endblock %}
