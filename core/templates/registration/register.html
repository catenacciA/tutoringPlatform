{% extends "base.html" %}
{% load static %}
{% load crispy_forms_filters %}
{% load crispy_forms_tags %}

{% block title %}Register{% endblock %}

{% block head %}
{{ block.super }}
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
<link href="{% static 'core/css/register.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="register-page">
    <div class="register-container">
        <div class="register-header">
            <h1><i class="bi bi-person-plus-fill"></i> Register</h1>
            <p>Create a new account to access our platform.</p>
        </div>
        <hr>
        <form id="register-form" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="profile-pic">
                <input type="file" name="propic" id="propic-input" accept="image/*" class="d-none" aria-label="Profile picture">
                <img id="profile-pic" src="{% static 'unknown_user.png' %}" alt="Profile Picture" onclick="document.getElementById('propic-input').click();">
                <i class="bi bi-trash trash-bin" onclick="resetProfilePicture()" title="Remove profile picture" role="button"></i>
                <input type="hidden" name="default_propic" id="default-propic" value="{% static 'unknown_user.png' %}">
                <input type="hidden" name="delete_propic" id="delete-propic" value="false">
            </div>
            {{ form.username|as_crispy_field }}
            {{ form.first_name|as_crispy_field }}
            {{ form.last_name|as_crispy_field }}
            {{ form.email|as_crispy_field }}
            {{ form.password1|as_crispy_field }}
            {{ form.password2|as_crispy_field }}
            {{ profile_form.is_tutor|as_crispy_field }}
            {{ profile_form.birth_date|as_crispy_field }}
            {{ profile_form.gender|as_crispy_field }}
            {{ profile_form.location|as_crispy_field }}
            {{ profile_form.address|as_crispy_field }}
            {{ profile_form.phone|as_crispy_field }}
            <button type="submit" class="btn btn-primary mt-3">Register</button>
        </form>
        <div id="form-messages" class="mt-3"></div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        $('#register-form').on('submit', function (e) {
            e.preventDefault();
            const formData = new FormData(this);

            $.ajax({
                url: '',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function (response) {
                    if (response.success) {
                        window.location.href = response.redirect_url;
                    } else {
                        displayErrors(response.errors, 'Form submission failed.');
                    }
                },
                error: function (xhr) {
                    let errorMessages = '<div class="alert alert-danger">An unknown error occurred.</div>';
                    if (xhr.status >= 500) {
                        errorMessages = '<div class="alert alert-danger">A server error occurred. Please try again later.</div>';
                    } else if (xhr.status >= 400) {
                        errorMessages = '<div class="alert alert-danger">A client error occurred. Please check your input and try again.</div>';
                    }
                    if (xhr.responseJSON && xhr.responseJSON.errors) {
                        displayErrors(xhr.responseJSON.errors, 'An error occurred.');
                    } else {
                        $('#form-messages').html(errorMessages);
                    }
                }
            });
        });

        function displayErrors(errors, message) {
            let errorMessages = `<div class="alert alert-danger">${message}</div>`;
            if (errors) {
                errorMessages = '<div class="alert alert-danger"><ul>';
                for (const field in errors) {
                    if (errors.hasOwnProperty(field)) {
                        errors[field].forEach(function (error) {
                            errorMessages += '<li>' + field + ': ' + error + '</li>';
                        });
                    }
                }
                errorMessages += '</ul></div>';
            }
            $('#form-messages').html(errorMessages);
        }

        document.getElementById('propic-input').onchange = function () {
            const reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById('profile-pic').src = e.target.result;
                document.getElementById('delete-propic').value = 'false';
            };
            reader.readAsDataURL(this.files[0]);
        };

        window.resetProfilePicture = function () {
            document.getElementById('profile-pic').src = document.getElementById('default-propic').value;
            document.getElementById('propic-input').value = ""; // Clear the input value
            document.getElementById('delete-propic').value = 'true';
        };
    });
</script>
{% endblock %}
