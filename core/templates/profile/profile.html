{% extends "base.html" %}
{% load static %}
{% load custom_filters %}

{% block title %}Profile Settings{% endblock %}

{% block head %}
{{ block.super }}
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
<link href="{% static 'core/css/profile.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="container profile-page">
    <div class="profile-content">
        <div class="profile-header">
            <h1 class="display-4"><i class="bi bi-person-circle"></i> Profile Settings</h1>
            <hr class="my-4">
        </div>
        <ul class="nav nav-tabs" id="profileTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile" type="button" role="tab" aria-controls="profile" aria-selected="true">Profile</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="account-tab" data-bs-toggle="tab" data-bs-target="#account" type="button" role="tab" aria-controls="account" aria-selected="false">Account</button>
            </li>
            {% if user.profile.is_tutor %}
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tutor-tab" data-bs-toggle="tab" data-bs-target="#tutor" type="button" role="tab" aria-controls="tutor" aria-selected="false">Tutor</button>
            </li>
            {% endif %}
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="lessons-tab" data-bs-toggle="tab" data-bs-target="#lessons" type="button" role="tab" aria-controls="lessons" aria-selected="false">Lessons</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab" aria-controls="settings" aria-selected="false">Settings</button>
            </li>
        </ul>
        <div class="tab-content mt-3" id="profileTabsContent">
            <div class="tab-pane fade show active" id="profile" role="tabpanel" aria-labelledby="profile-tab">
                <div class="profile-section text-center">
                    <div class="profile-pic mb-3">
                        {% if user.profile.is_tutor and user.tutor.profile_picture %}
                            <img id="profile-pic" src="{{ user.tutor.profile_picture.url }}" alt="Profile Picture">
                        {% elif user.profile.propic %}
                            <img id="profile-pic" src="{{ user.profile.propic.url }}" alt="Profile Picture">
                        {% else %}
                            <img id="profile-pic" src="{% static 'unknown_user.png' %}" alt="Unknown User">
                        {% endif %}
                    </div>
                    <h5>{{ user.get_full_name }}</h5>
                    <p>{{ user.email }}</p>
                </div>
                <div class="profile-info">
                    <h5><i class="bi bi-calendar"></i> Birth Date</h5>
                    <p>{{ user.profile.birth_date }}</p>
                    <h5><i class="bi bi-gender-ambiguous"></i> Gender</h5>
                    <p>{{ user.profile.get_gender_display }}</p>
                    <h5><i class="bi bi-geo-alt"></i> Location</h5>
                    <p>{{ user.profile.location }}</p>
                    <h5><i class="bi bi-house"></i> Address</h5>
                    <p>{{ user.profile.address }}</p>
                    <h5><i class="bi bi-telephone"></i> Phone</h5>
                    <p>{{ user.profile.phone }}</p>
                </div>
            </div>
            <div class="tab-pane fade" id="account" role="tabpanel" aria-labelledby="account-tab">
                <div class="profile-info">
                    <h5><i class="bi bi-person"></i> Username</h5>
                    <p>{{ user.username }}</p>
                    <h5><i class="bi bi-envelope"></i> Email</h5>
                    <p>{{ user.email }}</p>
                </div>
            </div>
            {% if user.profile.is_tutor %}
            <div class="tab-pane fade" id="tutor" role="tabpanel" aria-labelledby="tutor-tab">
                <div class="profile-info">
                    <h5><i class="bi bi-book"></i> Subjects</h5>
                    <ul>
                        {% for subject in user.tutor.subjects.all %}
                            <li>{{ subject.name }}</li>
                        {% endfor %}
                    </ul>
                    <h5><i class="bi bi-currency-dollar"></i> Hourly Rate</h5>
                    <p>${{ user.tutor.hourly_rate }}</p>
                    <h5><i class="bi bi-mortarboard"></i> Qualifications</h5>
                    <p>{{ user.tutor.qualifications }}</p>
                    <h5><i class="bi bi-briefcase"></i> Experience</h5>
                    <p>{{ user.tutor.experience }} years</p>
                    <h5><i class="bi bi-calendar-check"></i> Availability</h5>
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Day of Week</th>
                                <th>Start Time</th>
                                <th>End Time</th>
                                <th>Available</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for availability in user.tutor.availabilities.all %}
                            <tr>
                                <td>{{ availability.day_of_week }}</td>
                                <td>{{ availability.start_time }}</td>
                                <td>{{ availability.end_time }}</td>
                                <td>{{ availability.is_available|yesno:"Yes,No" }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}
            <div class="tab-pane fade" id="lessons" role="tabpanel" aria-labelledby="lessons-tab">
                <div class="profile-info">
                    <h5><i class="bi bi-journal-bookmark"></i> Lessons</h5>
                    {% if lessons or tutor_lessons %}
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Lesson Date</th>
                                <th>Start Time</th>
                                <th>End Time</th>
                                <th>Tutor/Student</th>
                                <th>Subject</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for lesson in lessons %}
                            <tr>
                                <td>{{ lesson.booking_date }}</td>
                                <td>{{ lesson.start_time }}</td>
                                <td>{{ lesson.end_time }}</td>
                                <td>{{ lesson.tutor.get_full_name }}</td>
                                <td>{{ lesson.subject }}</td>
                                <td>{{ lesson.get_status_display }}</td>
                                <td>
                                    {% if lesson.status == "completed" and not user.profile.is_tutor %}
                                        <a class="btn btn-success" href="{% url 'core:create_review' lesson.tutor.id lesson.pk %}">
                                            <i class="bi bi-pencil-square"></i> Leave a Review
                                        </a>
                                    {% else %}
                                        <a class="btn btn-warning" href="{% url 'core:modify_lesson' lesson.pk %}">
                                            <i class="bi bi-pencil"></i> Edit
                                        </a>
                                        <a class="btn btn-danger" href="{% url 'core:delete_lesson' lesson.pk %}">
                                            <i class="bi bi-trash"></i> Delete
                                        </a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                            {% for lesson in tutor_lessons %}
                            <tr>
                                <td>{{ lesson.booking_date }}</td>
                                <td>{{ lesson.start_time }}</td>
                                <td>{{ lesson.end_time }}</td>
                                <td>{{ lesson.student.get_full_name }}</td>
                                <td>{{ lesson.subject }}</td>
                                <td>{{ lesson.get_status_display }}</td>
                                <td>
                                    {% if lesson.status == "completed" and lesson_reviews|get_item:lesson.pk %}
                                        {% for review in lesson_reviews|get_item:lesson.pk %}
                                            <a class="btn btn-primary" href="{% url 'core:update_review' review.pk %}">
                                                <i class="bi bi-reply"></i> Respond to Review
                                            </a>
                                        {% endfor %}
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <p>No lessons booked.</p>
                    {% endif %}
                </div>
            </div>
            <div class="tab-pane fade" id="settings" role="tabpanel" aria-labelledby="settings-tab">
                <div class="profile-info">
                    <h5><i class="bi bi-gear"></i> Settings</h5>
                    <p>Additional settings can be configured here.</p>
                </div>
            </div>
        </div>
        <div class="text-center mt-4">
            <a class="btn btn-custom btn-lg" href="{% url 'core:edit_profile' %}" role="button">
                <i class="bi bi-pencil-square"></i> Edit Profile
            </a>
        </div>
    </div>
</div>
{% endblock %}
