{% extends "base.html" %}

{% load static %}
{% load crispy_forms_filters %}
{% load crispy_forms_tags %}

{% block title %}Edit Profile{% endblock %}

{% block head %}
{{ block.super }}
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
<link rel="stylesheet" href="{% static 'core/css/edit_profile.css' %}">
{% endblock %}

{% block content %}
<div class="container edit-profile-page">
    <div id="notification" class="notification"></div>
    <div class="profile-container">
        <!-- Profile Header Section -->
        <div class="profile-header">
            <div class="profile-pic">
                <input type="file" name="propic" id="propic-input" accept="image/*" class="d-none" form="main-form">
                {% include "profile/profile_picture.html" %}
                <input type="hidden" name="delete_propic" id="delete-propic" value="false" form="main-form">
                <input type="hidden" name="default_propic" id="default-propic" value="{% static 'unknown_user.png' %}" form="main-form">
            </div>
            <div class="profile-actions">
                <button type="button" class="btn btn-primary" onclick="document.getElementById('propic-input').click();">Change Picture</button>
                <button type="button" class="trash-bin" onclick="resetProfilePicture()">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>

        <!-- Profile Form Section -->
        <form id="main-form" method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            {{ user_form|crispy }}
            {{ form|crispy }}
            {% if tutor_form %}
                {{ tutor_form|crispy }}
            {% endif %}

            {% if tutor_form %}
                <div class="availability-container">
                    <h5>Availability</h5>
                    <div id="availability-list">
                        {{ availabilities_formset.management_form }}
                        {% for form in availabilities_formset %}
                            {% include "profile/availability_entry.html" with form=form counter=forloop.counter0 %}
                        {% endfor %}
                    </div>
                    <button type="button" class="btn btn-primary mt-3" onclick="addAvailability()">Add Availability</button>
                </div>
            {% endif %}

            <div class="form-group text-center mt-4">
                <button type="submit" name="save_profile" class="btn btn-success">Save Changes</button>
                <a href="{% url 'core:profile' %}" class="btn btn-secondary ml-2">Cancel</a>
            </div>
        </form>

        <!-- Password Change Section -->
        <form id="password-form" method="POST">
            {% csrf_token %}
            <h5>Change Password</h5>
            {{ password_form|crispy }}
            <div class="form-group text-center mt-4">
                <button type="submit" name="change_password" class="btn btn-warning">Change Password</button>
            </div>
        </form>
    </div>
</div>

<script id="daysOfWeek" type="application/json">{{ days_of_week_json|safe }}</script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
let availabilityCounter = {{ availabilities_formset.total_form_count | default:0 }};
const availabilityList = document.getElementById('availability-list');
const daysOfWeekScript = document.getElementById('daysOfWeek').textContent;
const daysOfWeek = JSON.parse(daysOfWeekScript);

function addAvailability() {
    const newEntry = document.createElement('div');
    newEntry.className = 'availability-entry row align-items-center mb-3';
    newEntry.id = `availability-entry-${availabilityCounter}`;

    newEntry.innerHTML = `
        <input type="hidden" name="form-${availabilityCounter}-id" id="id_form-${availabilityCounter}-id" value="">
        <input type="hidden" name="form-${availabilityCounter}-tutor" id="id_form-${availabilityCounter}-tutor" value="{{ user.tutor.id }}">

        <div class="col-sm-2">
            <label for="id_form-${availabilityCounter}-day_of_week">Day of Week</label>
            <select name="form-${availabilityCounter}-day_of_week" id="id_form-${availabilityCounter}-day_of_week" class="form-control" required>
                <option value="">Select Day</option>
                ${daysOfWeek.map(day => `<option value="${day}">${day}</option>`).join('')}
            </select>
        </div>

        <div class="col-sm-2">
            <label for="id_form-${availabilityCounter}-start_time">Start Time</label>
            <input type="time" name="form-${availabilityCounter}-start_time" id="id_form-${availabilityCounter}-start_time" class="form-control" required>
        </div>

        <div class="col-sm-2">
            <label for="id_form-${availabilityCounter}-end_time">End Time</label>
            <input type="time" name="form-${availabilityCounter}-end_time" id="id_form-${availabilityCounter}-end_time" class="form-control" required>
        </div>

        <div class="col-sm-2">
            <label for="id_form-${availabilityCounter}-is_available">Is Available</label>
            <select name="form-${availabilityCounter}-is_available" id="id_form-${availabilityCounter}-is_available" class="form-control" required>
                <option value="true">Yes</option>
                <option value="false">No</option>
            </select>
        </div>

        <div class="col-sm-1 d-flex align-items-center">
            <label for="id_form-${availabilityCounter}-DELETE" class="d-none">Delete</label>
            <input type="checkbox" name="form-${availabilityCounter}-DELETE" id="id_form-${availabilityCounter}-DELETE" class="d-none">
            <button type="button" class="btn btn-outline-danger ms-auto" onclick="removeAvailability('${availabilityCounter}')">
                <i class="bi bi-trash"></i>
            </button>
        </div>
    `;
    availabilityList.appendChild(newEntry);
    availabilityCounter++;
    document.getElementById('id_form-TOTAL_FORMS').value = availabilityCounter;
}


function removeAvailability(index) {
    console.log('Removing availability:', index);
    const entry = document.getElementById(`availability-entry-${index}`);
    if (entry) {
        entry.style.display = 'none';
        const deleteInput = document.getElementById(`id_form-${index}-DELETE`);
        if (deleteInput) {
            deleteInput.checked = true;
            deleteInput.value = 'on'; // Ensure DELETE field is correctly set
        }
        // Ensure form fields for the deleted entry are not required
        document.getElementById(`id_form-${index}-day_of_week`).required = false;
        document.getElementById(`id_form-${index}-start_time`).required = false;
        document.getElementById(`id_form-${index}-end_time`).required = false;
        document.getElementById(`id_form-${index}-is_available`).required = false;
    }
}

$(document).ready(function() {
    $('#main-form').on('submit', function(event) {
        event.preventDefault();
        let formData = new FormData(this);
        formData.append('save_profile', '1');

        $.ajax({
            url: '', // Ensure the correct URL
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            dataType: 'json',
            success: function(response) {
                if (response.success) {
                    showNotification(response.message);
                } else {
                    handleFormErrors(response.errors);
                }
            },
            error: function(xhr) {
                try {
                    const response = JSON.parse(xhr.responseText);
                    handleFormErrors(response.errors);
                } catch (e) {
                    alert('An error occurred while processing the form. Please try again.');
                }
            }
        });
    });

    $('#password-form').on('submit', function(event) {
        event.preventDefault();
        let formData = new FormData(this);
        formData.append('change_password', '1');

        $.ajax({
            url: '',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            dataType: 'json',
            success: function(response) {
                console.log('AJAX Success:', response);
                if (response.success) {
                    alert('Your password has been updated successfully!');
                } else {
                    handleFormErrors(response.errors);
                }
            },
            error: function(xhr) {
                try {
                    const response = JSON.parse(xhr.responseText);
                    console.log('AJAX Error Response:', response);
                    handleFormErrors(response.errors);
                } catch (e) {
                    console.error('Error parsing response:', e);
                    alert('An error occurred while changing the password. Please try again.');
                }
            }
        });
    });

    $('#propic-input').on('change', function(event) {
        previewImage(event);
    });
});

function showNotification(message) {
    const notification = document.getElementById('notification');
    notification.innerText = message;
    notification.classList.add('show');

    setTimeout(() => {
        notification.classList.remove('show');
    }, 3000); // Hide after 3 seconds
}

function handleFormErrors(errors) {
    let errorMsg = '';
    for (let field in errors) {
        if (errors.hasOwnProperty(field)) {
            errorMsg += `${field}: ${errors[field].join(', ')}\n`;
        }
    }
    alert('Error: ' + errorMsg);
}

function resetProfilePicture() {
    document.getElementById('profile-pic').src = document.getElementById('default-propic').value;
    document.getElementById('delete-propic').value = 'true';
}

function previewImage(event) {
    const reader = new FileReader();
    reader.onload = function() {
        const output = document.getElementById('profile-pic');
        output.src = reader.result;
        document.getElementById('delete-propic').value = 'false';
    };
    reader.readAsDataURL(event.target.files[0]);
}
</script>

{% endblock %}
